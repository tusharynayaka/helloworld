<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimal Meetup Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>
    <style>
        /* Custom styles for map and loading state */
        #map { height: 400px; border-radius: 0.75rem; }
        .isochrone-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.6rem;
            font-weight: bold;
            line-height: 1;
            border-radius: 9999px; /* fully rounded */
            text-transform: uppercase;
            color: white;
            margin-left: 0.5rem;
        }
        .travel-table {
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e5e7eb;
            width: 100%;
        }
        .travel-table th {
            background-color: #f3f4f6;
            color: #4b5563;
            text-align: left;
            padding: 8px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .travel-table td {
            border-bottom: 1px solid #f3f4f6;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .hidden { display: none !important; }

        /* Custom Leaflet Icons */
        .custom-div-icon { border: none !important; background: transparent !important; }
        .origin-marker > div { background-color: #ef4444; border: 3px solid white; }
        .center-marker > div { background-color: #4f46e5; border: 3px solid white; }
        .landmark-marker > div { background-color: #10b981; border: 3px solid white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="loading-spinner" class="loading-overlay fixed" style="z-index: 2000;">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-indigo-600 font-semibold">Loading App...</p>
        </div>
    </div>
    
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8 relative hidden">
        
        <header class="mb-8 flex justify-between items-center border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                üìç Meetup Pro
            </h1>
            <div class="flex items-center space-x-3">
                <span id="user-display-name" class="font-medium text-indigo-600">Guest</span>
                <button id="go-to-profile-btn" class="text-sm text-gray-600 hover:text-indigo-600 underline">Update Profile</button>
            </div>
        </header>

        <div id="status-container" class="p-3 mb-6 rounded-lg bg-indigo-100 text-indigo-800 font-medium hidden">
            <p id="status-message">Loading...</p>
        </div>

        <div id="main-view">
            
            <div id="profile-view" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üè† Setup Your Home Location</h2>
                <p class="text-gray-600 mb-4">We need your name and a reference point (like Pin Code + City) to calculate the best meetup spot.</p>
                <form id="profile-form">
                    <div class="mb-4">
                        <label for="profile-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                        <input type="text" id="profile-name-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div class="mb-4">
                        <label for="home-locality" class="block text-sm font-medium text-gray-700">Home Locality / Pin Code & City</label>
                        <input type="text" id="home-locality-input" required placeholder="e.g., 560013, Bengaluru" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        <p class="text-xs text-gray-500 mt-1">This will be used to get your precise latitude and longitude via Latlong.ai Geocoding.</p>
                    </div>
                    <button type="submit" id="save-profile-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Save Profile & Continue
                    </button>
                </form>
            </div>

            <div id="create-join-view" class="space-y-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ü§ù Start or Join a Session</h2>

                <div id="create-group-section" class="bg-white p-6 rounded-xl shadow-lg border border-indigo-200">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-3">üöÄ Create New Meetup</h3>
                    <div class="mb-4">
                        <label for="occasion-create" class="block text-sm font-medium text-gray-700">What are you meeting for?</label>
                        <select id="occasion-create" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="">Select an Occasion</option>
                            <option value="Casual Dinner">Casual Dinner</option>
                            <option value="Business Meeting">Business Meeting</option>
                            <option value="Weekend Trip">Weekend Trip</option>
                            <option value="Study Session">Study Session</option>
                        </select>
                    </div>
                    <button id="create-group-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Create Group
                    </button>
                    <button id="show-join-btn" class="w-full mt-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        I have a code, let me join
                    </button>
                </div>

                <div id="join-group-section" class="bg-white p-6 rounded-xl shadow-lg border border-green-200 hidden">
                    <h3 class="text-xl font-semibold text-green-700 mb-3">üîó Join Existing Meetup</h3>
                    <div class="mb-4">
                        <label for="join-code-input" class="block text-sm font-medium text-gray-700">Enter 4-Digit Join Code</label>
                        <input type="text" id="join-code-input" maxlength="4" placeholder="e.g., ABCD" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border uppercase text-center font-bold text-lg">
                    </div>
                    <button id="join-by-code-btn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                        Join Session
                    </button>
                    <button id="show-create-btn" class="w-full mt-2 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        I want to create a new session
                    </button>
                </div>
            </div>

            <div id="session-view" class="space-y-8 hidden">
                
                <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-400">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Active Session <span id="session-occasion" class="text-lg font-normal text-indigo-500"></span></h2>
                        <button id="end-session-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">End Session</button>
                    </div>
                    
                    <div class="flex items-center justify-between border-b pb-3 mb-3">
                        <p class="text-lg font-medium text-gray-700">
                            Join Code: 
                            <span id="session-join-code" class="text-2xl font-extrabold text-indigo-600 tracking-wider ml-2">ABCD</span>
                        </p>
                        <button id="copy-code-btn" class="py-1 px-3 border border-indigo-300 rounded-md text-xs font-medium text-indigo-600 bg-indigo-50 hover:bg-indigo-100">
                            Copy Code
                        </button>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-2 flex justify-between items-center">
                        Participants (<span id="participant-count">0</span>)
                    </h3>
                    <div id="participants-list" class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                        </div>
                    
                    <div class="mt-6">
                        <button id="calculate-btn" disabled class="w-full py-3 px-4 rounded-md shadow-lg text-lg font-bold text-white bg-green-600 disabled:bg-gray-400 hover:bg-green-700 disabled:hover:bg-gray-400 transition-colors">
                            Calculate Optimal Meetup Spot
                        </button>
                        <p class="text-center text-sm text-gray-500 mt-2">Need at least 2 participants.</p>
                    </div>
                </div>

                <div id="results-section" class="hidden space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Optimal Location Results üèÜ</h2>

                    <div id="map-container" class="bg-white p-4 rounded-xl shadow-lg">
                        <div id="map"></div>
                    </div>
                    
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-700">Top Recommendations (Ranked by Total Travel Distance)</h3>
                        <div id="recommendations-list" class="space-y-4">
                            </div>
                    </div>

                    <div id="sources-container" class="text-xs text-gray-500 border-t pt-4">
                        </div>
                </div>
            </div>

        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>

    <script>
        // =========================================================================
        // 1. CONFIGURATION & GLOBAL STATE
        // =========================================================================
        
        // --- Firebase Config (REPLACE WITH YOUR ACTUAL CONFIG) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- Latlong.ai API Configuration (REPLACE WITH YOUR TOKEN) ---
        const LATLONG_API_TOKEN = 'YOUR_LATLONG_API_TOKEN'; 
        const GEOCODE_URL = 'https://api.latlong.ai/geocode';
        const DISTANCE_URL = 'https://api.latlong.ai/distance-matrix';
        const LANDMARK_URL = 'https://api.latlong.ai/landmarks';
        
        // --- Global State Variables ---
        let db;
        let auth;
        let userId = null;
        let userProfile = null;
        let currentGroupId = null;
        let groupUnsubscribe = null;
        let map = null;
        let markers = L.layerGroup(); 
        let isAuthReady = false;

        // --- Firestore Paths ---
        const PROFILE_COLLECTION_PATH = 'user_profiles';
        const GROUP_COLLECTION_PATH = 'meetup_groups';

        // --- DOM Elements ---
        const APP_CONTAINER = document.getElementById('app-container');
        const LOADING_SPINNER = document.getElementById('loading-spinner');
        const STATUS_CONTAINER = document.getElementById('status-container');
        const STATUS_MESSAGE = document.getElementById('status-message');
        const USER_DISPLAY_NAME = document.getElementById('user-display-name');
        const GO_TO_PROFILE_BTN = document.getElementById('go-to-profile-btn');

        // Views
        const PROFILE_VIEW = document.getElementById('profile-view');
        const CREATE_JOIN_VIEW = document.getElementById('create-join-view');
        const SESSION_VIEW = document.getElementById('session-view');

        // Profile Form Elements
        const PROFILE_FORM = document.getElementById('profile-form');
        const PROFILE_NAME_INPUT = document.getElementById('profile-name-input');
        const HOME_LOCALITY_INPUT = document.getElementById('home-locality-input');
        const SAVE_PROFILE_BTN = document.getElementById('save-profile-btn');

        // Create/Join Elements
        const CREATE_GROUP_BTN = document.getElementById('create-group-btn');
        const JOIN_BY_CODE_BTN = document.getElementById('join-by-code-btn');
        const JOIN_CODE_INPUT = document.getElementById('join-code-input');
        const OCCASION_CREATE = document.getElementById('occasion-create');
        const SHOW_CREATE_BTN = document.getElementById('show-create-btn');
        const SHOW_JOIN_BTN = document.getElementById('show-join-btn');
        const CREATE_GROUP_SECTION = document.getElementById('create-group-section');
        const JOIN_GROUP_SECTION = document.getElementById('join-group-section');

        // Session Elements
        const SESSION_JOIN_CODE = document.getElementById('session-join-code');
        const PARTICIPANT_COUNT = document.getElementById('participant-count');
        const PARTICIPANTS_LIST = document.getElementById('participants-list');
        const CALCULATE_BTN = document.getElementById('calculate-btn');
        const END_SESSION_BTN = document.getElementById('end-session-btn');
        const COPY_CODE_BTN = document.getElementById('copy-code-btn');
        const SESSION_OCCASION = document.getElementById('session-occasion');

        // Results Elements
        const RESULTS_SECTION = document.getElementById('results-section');
        const RECOMMENDATIONS_LIST = document.getElementById('recommendations-list');

        // Firebase Imports
        const { initializeApp } = firebase;
        const { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, onSnapshot, arrayUnion, deleteDoc } = firebase.firestore;
        const { getAuth, signInAnonymously, onAuthStateChanged } = firebase.auth;

        // =========================================================================
        // 2. UTILITY FUNCTIONS
        // =========================================================================

        function setView(mainView, subView = null) {
            APP_CONTAINER.classList.remove('hidden');
            LOADING_SPINNER.classList.add('hidden');

            PROFILE_VIEW.classList.add('hidden');
            CREATE_JOIN_VIEW.classList.add('hidden');
            SESSION_VIEW.classList.add('hidden');
            
            if (mainView === 'profile') {
                PROFILE_VIEW.classList.remove('hidden');
            } else if (mainView === 'main') {
                if (subView === 'session') {
                    SESSION_VIEW.classList.remove('hidden');
                } else {
                    CREATE_JOIN_VIEW.classList.remove('hidden');
                    CREATE_GROUP_SECTION.classList.toggle('hidden', subView === 'join');
                    JOIN_GROUP_SECTION.classList.toggle('hidden', subView === 'create');
                }
            }
        }

        function showStatus(message, isError) {
            STATUS_MESSAGE.textContent = message;
            STATUS_CONTAINER.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-indigo-100', 'text-indigo-800');
            if (isError) {
                STATUS_CONTAINER.classList.add('bg-red-100', 'text-red-800');
                console.error(message);
            } else {
                STATUS_CONTAINER.classList.add('bg-indigo-100', 'text-indigo-800');
                console.log(message);
            }
        }

        function setButtonLoading(isLoading, button = null) {
            const btn = button || CALCULATE_BTN;
            if (!btn) return;
            
            btn.disabled = isLoading;
            const originalText = btn.dataset.originalText || btn.textContent;

            if (isLoading) {
                btn.dataset.originalText = originalText;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V2a10 10 0 00-7.07 17.07l1.41-1.41A8 8 0 0112 4z"/></svg> Processing...`;
                btn.classList.add('flex', 'items-center', 'justify-center');
            } else {
                btn.textContent = originalText;
                btn.classList.remove('flex', 'items-center', 'justify-center');
            }
        }

        function generateGroupCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus(`Copied code ${text} to clipboard!`, false);
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showStatus('Failed to copy code.', true);
            });
        }

        function formatDistance(meters, isRouted) {
            if (!isRouted) {
                return `${(meters / 1000).toFixed(2)} km (Straight-line)`;
            }
            if (meters < 1000) {
                return `${meters.toFixed(0)} m`;
            }
            return `${(meters / 1000).toFixed(2)} km`;
        }

        function formatTime(seconds) {
            if (seconds === Infinity) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes} min`;
        }

        // --- Leaflet Map Functions ---

        function initMap(lat, lon) {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markers.addTo(map);
            markers.clearLayers(); 
        }

        function addMarker(lat, lon, popupText, type) {
            let color;
            let size = 30;

            if (type === 'origin') {
                color = '#ef4444'; // Red
            } else if (type === 'center') {
                color = '#4f46e5'; // Indigo (Centroid)
                size = 36;
            } else {
                color = '#10b981'; // Green (Landmark)
            }

            const customIcon = L.divIcon({
                className: `custom-div-icon`,
                html: `<div class="${type}-marker" style="width: ${size}px; height: ${size}px; border-radius: 50%; display: flex; justify-content: center; align-items: center;"></div>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size]
            });

            const marker = L.marker([lat, lon], {icon: customIcon})
                .bindPopup(popupText, { closeButton: false, autoClose: false })
                .openPopup();
            
            markers.addLayer(marker);
        }

        // =========================================================================
        // 3. LATLONG.AI API WRAPPERS
        // =========================================================================

        async function geocodeAddress(address) {
            const endpoint = `${GEOCODE_URL}?address=${encodeURIComponent(address)}`;
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'X-Authorization-Token': LATLONG_API_TOKEN }
                });

                if (!response.ok) {
                    console.error(`Latlong Geocoding HTTP Error ${response.status}`);
                    return null;
                }
                
                const data = await response.json();

                if (data.status === 'success' && data.data.latitude && data.data.longitude) {
                    return {
                        lat: parseFloat(data.data.latitude),
                        lon: parseFloat(data.data.longitude)
                    };
                }
                
                console.warn('Latlong Geocoding failed:', data.message || data.status);
                return null;
            } catch (error) {
                console.error('Network or parsing error during geocoding:', error);
                return null;
            }
        }

        async function getDistanceMatrix(origin, destination, mode = 'driving') {
            const endpoint = `${DISTANCE_URL}?origins=${origin}&destinations=${destination}&mode=${mode}`; 
            
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'X-Authorization-Token': LATLONG_API_TOKEN }
                });

                if (!response.ok) {
                    console.error(`Latlong Distance Matrix HTTP Error ${response.status}`);
                    return { distance: Infinity, duration: Infinity, status: 'HTTP_ERROR' };
                }
                
                const data = await response.json();

                if (data.status === 'success' && data.data?.rows[0]?.elements[0]?.status === 'OK') {
                    const element = data.data.rows[0].elements[0];
                    return {
                        distance: element.distance.value, // in meters
                        duration: element.duration.value, // in seconds
                        status: 'OK'
                    };
                }
                
                // Handle API error or non-OK status
                const status = data.data?.rows[0]?.elements[0]?.status || data.message || 'ERROR';
                const errorStatus = (status === 'ZERO_RESULTS' || status === 'NOT_FOUND') ? 'ROUTE_NOT_FOUND' : status;
                
                console.warn(`Latlong Distance Matrix failed: Status: ${status}. Falling back to Haversine.`, data);
                return { distance: Infinity, duration: Infinity, status: errorStatus }; 

            } catch (error) {
                console.error('Network or parsing error during Distance Matrix:', error);
                return { distance: Infinity, duration: Infinity, status: 'NETWORK_ERROR' }; 
            }
        }

        async function getLandmarks(lat, lon, radius) {
            // Using dynamic radius in meters
            const endpoint = `${LANDMARK_URL}?latitude=${lat}&longitude=${lon}&radius=${radius}`; 
            
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'X-Authorization-Token': LATLONG_API_TOKEN }
                });

                if (!response.ok) {
                    console.error(`Latlong Landmark HTTP Error ${response.status}`);
                    return [];
                }
                
                const data = await response.json();

                if (data.status === 'success' && Array.isArray(data.data)) {
                    return data.data.map(landmark => ({
                        name: landmark.name,
                        lat: parseFloat(landmark.latitude),
                        lon: parseFloat(landmark.longitude)
                    }));
                }
                
                console.warn('Latlong Landmark API failed or returned no results:', data.message || data.status);
                return [];
            } catch (error) {
                console.error('Network or parsing error during Landmark search:', error);
                return [];
            }
        }
        
        // --- Haversine and Center Calculation Utilities ---

        function haversineDistance(lat1, lon1, lat2, lon2) {
            // Implements Haversine distance in meters
            const R = 6371e3; // Earth radius in metres
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                        Math.cos(œÜ1) * Math.cos(œÜ2) *
                        Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // in metres
        }

        function calculateGeometricCenter(participants) {
            let sumLat = 0, sumLon = 0;
            if (participants.length === 0) return null;

            participants.forEach(p => {
                sumLat += p.lat;
                sumLon += p.lon;
            });

            return {
                lat: sumLat / participants.length,
                lon: sumLon / participants.length
            };
        }

        function calculateMaxSpread(participants) {
            let maxDistance = 0;
            if (participants.length < 2) return 0;

            for (let i = 0; i < participants.length; i++) {
                for (let j = i + 1; j < participants.length; j++) {
                    const dist = haversineDistance(
                        participants[i].lat, participants[i].lon,
                        participants[j].lat, participants[j].lon
                    );
                    if (dist > maxDistance) {
                        maxDistance = dist;
                    }
                }
            }
            return maxDistance;
        }


        // =========================================================================
        // 4. CORE CALCULATION LOGIC
        // =========================================================================

        async function findOptimalMeetupLocation() {
            setButtonLoading(true);
            RESULTS_SECTION.classList.add('hidden');
            RECOMMENDATIONS_LIST.innerHTML = '';
            showStatus('Step 1/4: Locating participants and calculating geometric center...', false);

            try {
                const groupDocRef = doc(db, GROUP_COLLECTION_PATH, currentGroupId);
                const groupSnapshot = await getDoc(groupDocRef);
                if (!groupSnapshot.exists()) {
                    throw new Error('Group session not found or deleted.');
                }
                const groupData = groupSnapshot.data();
                const participants = groupData.participants || [];

                // 1. Validate participant coordinates
                const validParticipants = participants.filter(p => p.lat && p.lon);
                if (validParticipants.length < 2) {
                    throw new Error('Need at least 2 participants with valid addresses to calculate the center. Please ensure all participants have saved a valid Pin Code and City.');
                }
                
                const center = calculateGeometricCenter(validParticipants);
                let potentialLocations = [];
                let landmarkData = [];
                
                // Always include the theoretical center as a primary candidate
                potentialLocations.push({ 
                    name: `Theoretical Geometric Center`, 
                    lat: center.lat, 
                    lon: center.lon,
                    isCentroid: true
                });


                // 2. Landmark Search Strategy
                const maxSpread = calculateMaxSpread(validParticipants);
                const dynamicRadius = Math.max(5000, Math.min(Math.floor(maxSpread / 2), 20000)); 
                const broadRadius = 15000; // Fixed 15 km fallback search radius

                showStatus(`Step 2/4: Searching for landmarks within dynamic radius of ${formatDistance(dynamicRadius, false)}...`, false);
                
                // Attempt 1: Dynamic Radius Search
                landmarkData = await getLandmarks(center.lat, center.lon, dynamicRadius);
                
                if (landmarkData.length === 0) {
                    showStatus(`Step 2/4: Dynamic search failed. Retrying with a broader radius of ${formatDistance(broadRadius, false)}...`, false);
                    
                    // Attempt 2: Broad Fixed Radius Search
                    landmarkData = await getLandmarks(center.lat, center.lon, broadRadius);
                }
                
                if (landmarkData.length > 0) {
                    potentialLocations.push(...landmarkData);
                    showStatus(`Step 3/4: Found ${landmarkData.length} landmarks. Calculating routes...`, false);
                } else {
                    showStatus('Step 3/4: Could not find specific nearby landmarks, even with a broader search. Calculating travel distance only to the theoretical center.', false);
                }

                // 4. Calculate Distance Matrix for all potential locations
                
                const results = [];
                showStatus(`Step 4/4: Calculating ${validParticipants.length * potentialLocations.length} possible routes via Latlong.ai Distance Matrix...`, false);


                for (let i = 0; i < potentialLocations.length; i++) {
                    const location = potentialLocations[i];
                    const destinationCoordinate = `${location.lat},${location.lon}`;
                    
                    let locationTotalDistance = 0;
                    let locationMaxDuration = 0;
                    let allRouted = true;
                    const travelDetails = [];
                    
                    for (let j = 0; j < validParticipants.length; j++) {
                        const p = validParticipants[j];
                        const singleOrigin = `${p.lat},${p.lon}`;

                        const singleResult = await getDistanceMatrix(singleOrigin, destinationCoordinate, 'driving');
                        
                        let finalDistance = singleResult.distance;
                        let finalDuration = singleResult.duration;
                        let isRouted = (singleResult.status === 'OK');

                        // FALLBACK LOGIC: If Distance Matrix fails, use Haversine distance.
                        if (!isRouted) {
                            finalDistance = haversineDistance(p.lat, p.lon, location.lat, location.lon);
                            finalDuration = Infinity; 
                            allRouted = false;
                        }
                        
                        locationTotalDistance += finalDistance;
                        // Max duration only tracks valid routed times.
                        if (finalDuration !== Infinity) {
                            locationMaxDuration = Math.max(locationMaxDuration, finalDuration);
                        }

                        travelDetails.push({
                            displayName: p.displayName,
                            distance: finalDistance,
                            duration: finalDuration,
                            isRouted: isRouted
                        });
                    }

                    results.push({
                        rank: 0, 
                        placeName: location.name,
                        lat: location.lat,
                        lon: location.lon,
                        totalDistance: locationTotalDistance, // Key metric for ranking
                        maxDuration: locationMaxDuration,
                        travelDetails: travelDetails,
                        isCentroid: location.isCentroid || false,
                        allRouted: allRouted // True if ALL participants got a routed distance
                    });
                }

                // 5. Sort and Display Results
                const sortedResults = results
                    .sort((a, b) => {
                        // Prioritize results where ALL routes were successfully calculated
                        if (a.allRouted !== b.allRouted) {
                            return a.allRouted ? -1 : 1; 
                        }
                        // Then sort by total distance
                        return a.totalDistance - b.totalDistance;
                    })
                    .slice(0, 5); // Show top 5

                displayResults(sortedResults, validParticipants);

                showStatus('Calculation complete! Results displayed.', false);
            } catch (error) {
                console.error("Calculation failed:", error);
                showStatus(`Calculation failed: ${error.message}`, true);
            } finally {
                setButtonLoading(false);
            }
        }
        
        // --- Display Functions ---

        function displayResults(results, validParticipants) {
            RECOMMENDATIONS_LIST.innerHTML = '';
            
            if (results.length === 0) {
                RECOMMENDATIONS_LIST.innerHTML = '<p class="text-gray-500 italic">No valid meetup locations could be calculated. Please check your addresses or API quota.</p>';
                RESULTS_SECTION.classList.remove('hidden');
                return;
            }
            
            // Initialize Map
            const initialCenter = results[0];
            initMap(initialCenter.lat, initialCenter.lon);

            // Track map bounds (Include all locations and participants for accurate zoom)
            const bounds = L.latLngBounds([]);

            // 1. Add participant markers and update bounds
            validParticipants.forEach(p => {
                addMarker(p.lat, p.lon, `**${p.displayName}** (Origin: ${p.homeLocality})`, 'origin');
                bounds.extend([p.lat, p.lon]);
            });
            
            results.forEach((location, index) => {
                location.rank = index + 1;
                
                // 2. Add Location Marker and update bounds
                const markerType = location.isCentroid ? 'center' : 'landmark';
                addMarker(location.lat, location.lon, `**#${index + 1} ${location.placeName}**<br>Total Distance: ${formatDistance(location.totalDistance, location.allRouted)}`, markerType);
                bounds.extend([location.lat, location.lon]);


                let detailsHtml = location.travelDetails.map(d => `
                    <tr>
                        <td class="px-2 py-1 text-sm text-gray-700 font-medium">${d.displayName}</td>
                        <td class="px-2 py-1 text-sm ${d.isRouted ? 'text-gray-600' : 'text-red-600 font-semibold'}">${formatDistance(d.distance, d.isRouted)}</td>
                        <td class="px-2 py-1 text-sm ${d.isRouted ? 'text-gray-600' : 'text-red-600 font-semibold'}">${d.isRouted ? formatTime(d.duration) : 'No Route Found'}</td>
                    </tr>
                `).join('');
                
                const centroidNote = location.isCentroid ? '<p class="text-sm italic text-indigo-600 mb-2">This is the **Mathematical Center**. Landmark suggestions follow.</p>' : '';
                const routingWarning = location.allRouted ? '' : '<p class="text-xs font-semibold text-red-600 mt-2">‚ö†Ô∏è Note: Some distances are straight-line (Haversine) as a precise driving route could not be found for all origins. This location is still ranked highly based on its geometric distance.</p>';

                const cardHtml = `
                    <div class="p-5 border-2 rounded-xl transition-shadow ${index === 0 ? 'bg-green-50 border-green-300 shadow-lg' : 'bg-white border-gray-200 shadow-md hover:shadow-lg'}">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-bold ${index === 0 ? 'text-green-700' : 'text-indigo-700'}">
                                ${index + 1}. ${location.placeName}
                                ${index === 0 ? '<span class="isochrone-badge bg-green-500">BEST ACCESS</span>' : ''}
                            </h3>
                        </div>
                        ${centroidNote}
                        <p class="text-gray-600 mb-2 text-sm italic">Lat: ${location.lat.toFixed(5)}, Lon: ${location.lon.toFixed(5)}</p>
                        <p class="text-gray-600 mb-4 text-sm font-medium">Worst-case travel time (Routed): **${location.maxDuration !== 0 ? formatTime(location.maxDuration) : 'N/A (No Valid Routed Times)'}**.</p>
                    
                        <div class="overflow-x-auto">
                            <table class="min-w-full travel-table rounded-lg">
                                <thead>
                                    <tr>
                                        <th class="rounded-tl-lg">Participant</th>
                                        <th>Distance</th>
                                        <th class="rounded-tr-lg">Time (Driving)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${detailsHtml}
                                </tbody>
                            </table>
                            ${routingWarning}
                        </div>
                    </div>
                `;
                RECOMMENDATIONS_LIST.innerHTML += cardHtml;
            });
            
            // 3. Fit Map to Bounds
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                 // Fallback if only one or no points are valid
                map.setView([initialCenter.lat, initialCenter.lon], 10);
            }

            RESULTS_SECTION.classList.remove('hidden');
            // Force map redraw after section becomes visible
            setTimeout(() => map.invalidateSize(), 300); 
            document.getElementById('sources-container').innerHTML = `
                <p class="font-medium mb-2">Data Source: **Latlong.ai API Hub** (Geocoding, Distance Matrix, Landmark APIs)</p>
            `;
        }


        // =========================================================================
        // 5. FIREBASE & GROUP MANAGEMENT LOGIC
        // =========================================================================
        
        async function loadUserProfile() {
            const userDocRef = doc(db, PROFILE_COLLECTION_PATH, userId);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                userProfile = docSnap.data();
                USER_DISPLAY_NAME.textContent = userProfile.displayName;
                setView('main', userProfile.currentGroupId ? 'session' : 'create');
                if (userProfile.currentGroupId) {
                    currentGroupId = userProfile.currentGroupId;
                    setupGroupListener(currentGroupId);
                }
            } else {
                setView('profile');
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            setButtonLoading(true, SAVE_PROFILE_BTN);

            const displayName = PROFILE_NAME_INPUT.value.trim();
            const homeLocality = HOME_LOCALITY_INPUT.value.trim();

            if (!displayName || !homeLocality) {
                showStatus('Display Name and Home Locality (Pin Code + City) are required.', true);
                setButtonLoading(false, SAVE_PROFILE_BTN);
                return;
            }

            try {
                showStatus('Verifying Pin Code and Locality via Latlong.ai Geocoding...', false);
                const coords = await geocodeAddress(homeLocality);

                if (!coords) {
                    throw new Error("Could not find precise coordinates for the provided Pin Code/Address. Please ensure you entered the Pin Code followed by the City/Locality (e.g., 560013, Bengaluru).");
                }

                userProfile = {
                    displayName: displayName,
                    homeLocality: homeLocality,
                    lat: coords.lat,
                    lon: coords.lon,
                    currentGroupId: userProfile ? userProfile.currentGroupId : null
                };

                const userDocRef = doc(db, PROFILE_COLLECTION_PATH, userId);
                await setDoc(userDocRef, userProfile, { merge: true });

                showStatus('Profile saved successfully! Coordinates received.', false);
                USER_DISPLAY_NAME.textContent = userProfile.displayName;
                setView('main', userProfile.currentGroupId ? 'session' : 'create');
            } catch (error) {
                console.error("Error saving profile:", error);
                const displayMessage = error.message.includes("coordinates") ? 
                    error.message : 
                    `Error saving profile: ${error.message}`;
                    
                showStatus(displayMessage, true);
            } finally {
                setButtonLoading(false, SAVE_PROFILE_BTN);
            }
        }

        async function createGroup() {
            setButtonLoading(true, CREATE_GROUP_BTN);
            try {
                const occasion = OCCASION_CREATE.value;
                if (!occasion) {
                    showStatus('Please select an occasion.', true);
                    setButtonLoading(false, CREATE_GROUP_BTN);
                    return;
                }

                const newCode = generateGroupCode();
                const newGroupRef = await addDoc(collection(db, GROUP_COLLECTION_PATH), {
                    code: newCode,
                    occasion: occasion,
                    participants: [{
                        userId: userId,
                        displayName: userProfile.displayName,
                        homeLocality: userProfile.homeLocality,
                        lat: userProfile.lat,
                        lon: userProfile.lon
                    }],
                    createdAt: new Date().toISOString()
                });

                currentGroupId = newGroupRef.id;
                userProfile.currentGroupId = currentGroupId;
                await setDoc(doc(db, PROFILE_COLLECTION_PATH, userId), { currentGroupId: currentGroupId }, { merge: true });

                setupGroupListener(currentGroupId);
                setView('main', 'session');
                showStatus(`Group created! Code: ${newCode}`, false);

            } catch (error) {
                console.error("Error creating group:", error);
                showStatus(`Error creating group: ${error.message}`, true);
            } finally {
                setButtonLoading(false, CREATE_GROUP_BTN);
            }
        }

        async function joinGroupByCode() {
            setButtonLoading(true, JOIN_BY_CODE_BTN);
            const code = JOIN_CODE_INPUT.value.trim().toUpperCase();

            try {
                const q = query(collection(db, GROUP_COLLECTION_PATH), where("code", "==", code));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showStatus('Error: Invalid or expired group code.', true);
                    return;
                }

                const groupDoc = querySnapshot.docs[0];
                const groupId = groupDoc.id;
                const groupData = groupDoc.data();

                // Check if already a participant
                const isParticipant = groupData.participants.some(p => p.userId === userId);
                if (!isParticipant) {
                    const participantData = {
                        userId: userId,
                        displayName: userProfile.displayName,
                        homeLocality: userProfile.homeLocality,
                        lat: userProfile.lat,
                        lon: userProfile.lon
                    };
                    
                    const groupDocRef = doc(db, GROUP_COLLECTION_PATH, groupId);
                    await updateDoc(groupDocRef, {
                        participants: arrayUnion(participantData)
                    });
                }

                currentGroupId = groupId;
                userProfile.currentGroupId = currentGroupId;
                await setDoc(doc(db, PROFILE_COLLECTION_PATH, userId), { currentGroupId: currentGroupId }, { merge: true });

                setupGroupListener(currentGroupId);
                setView('main', 'session');
                showStatus(`Successfully joined group: ${code}`, false);

            } catch (error) {
                console.error("Error joining group:", error);
                showStatus(`Error joining group: ${error.message}`, true);
            } finally {
                setButtonLoading(false, JOIN_BY_CODE_BTN);
            }
        }

        function setupGroupListener(groupId) {
            if (groupUnsubscribe) groupUnsubscribe(); 
            const groupDocRef = doc(db, GROUP_COLLECTION_PATH, groupId);
            groupUnsubscribe = onSnapshot(groupDocRef, handleGroupSnapshot, (error) => {
                console.error("Group listener error:", error);
                showStatus("Group session connection lost.", true);
            });
        }

        function handleGroupSnapshot(docSnapshot) {
            if (map) map.remove(); 
            markers.clearLayers();
            RESULTS_SECTION.classList.add('hidden'); 

            if (!docSnapshot.exists()) {
                currentGroupId = null;
                userProfile.currentGroupId = null;
                setDoc(doc(db, PROFILE_COLLECTION_PATH, userId), { currentGroupId: null }, { merge: true });
                setView('main', 'create');
                showStatus('The session you were in has ended.', true);
                CALCULATE_BTN.disabled = true;
                return;
            }

            const groupData = docSnapshot.data();
            const participants = groupData.participants || [];

            SESSION_JOIN_CODE.textContent = groupData.code;
            PARTICIPANT_COUNT.textContent = participants.length;
            SESSION_OCCASION.textContent = `(${groupData.occasion})`;

            PARTICIPANTS_LIST.innerHTML = participants.map(p => {
                const isCurrent = p.userId === userId;
                const badge = isCurrent ? `<span class="bg-indigo-200 text-indigo-800 text-xs font-semibold px-2 py-0.5 rounded ml-2">You</span>` : '';
                const coordsDisplay = p.lat && p.lon ? `[${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}]` : `<span class="text-red-500 font-bold">ADDRESS FAILED</span>`;
                
                return `
                    <div class="text-sm ${isCurrent ? 'font-bold text-indigo-700' : 'text-gray-700'} border-b border-gray-100 p-1 last:border-b-0">
                        ${p.displayName}${badge}
                        <span class="text-xs text-gray-500 italic block mt-0.5">
                            Pin Code: ${p.homeLocality}
                            <span class="ml-2">Coords: ${coordsDisplay}</span>
                        </span>
                    </div>
                `;
            }).join('');

            CALCULATE_BTN.disabled = participants.length < 2;
        }

        async function endSession() {
            if (!currentGroupId) return;

            const groupDocRef = doc(db, GROUP_COLLECTION_PATH, currentGroupId);
            try {
                await deleteDoc(groupDocRef); // Use deleteDoc to remove the group
            } catch (error) {
                console.error("Error deleting group:", error);
            }
            
            if (groupUnsubscribe) groupUnsubscribe();
            currentGroupId = null;
            userProfile.currentGroupId = null;
            await setDoc(doc(db, PROFILE_COLLECTION_PATH, userId), { currentGroupId: null }, { merge: true });

            setView('main', 'create');
            showStatus('Session successfully ended.', false);
            RESULTS_SECTION.classList.add('hidden');
        }


        // =========================================================================
        // 6. INITIALIZATION & EVENT LISTENERS
        // =========================================================================

        function setupListeners() {
            PROFILE_FORM.addEventListener('submit', saveProfile);
            GO_TO_PROFILE_BTN.addEventListener('click', () => setView('profile'));
            
            SHOW_CREATE_BTN.addEventListener('click', () => setView('main', 'create'));
            SHOW_JOIN_BTN.addEventListener('click', () => setView('main', 'join'));

            CREATE_GROUP_BTN.addEventListener('click', createGroup);
            JOIN_BY_CODE_BTN.addEventListener('click', joinGroupByCode);
            END_SESSION_BTN.addEventListener('click', endSession);
            COPY_CODE_BTN.addEventListener('click', () => copyToClipboard(SESSION_JOIN_CODE.textContent));
            
            CALCULATE_BTN.addEventListener('click', findOptimalMeetupLocation);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Initialize Leaflet functions only after DOM is ready
                setupListeners();

                // Start anonymous authentication immediately
                await signInAnonymously(auth);
                
                // Set up the listener for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) userId = user.uid;
                    else userId = crypto.randomUUID();
                    isAuthReady = true;
                    // Once authenticated, load the user's profile
                    await loadUserProfile();
                });
            } catch (error) {
                console.error('Firebase Initialization Error:', error);
                showStatus(`Firebase failed: ${error.message}. Group features may not work.`, true);
                isAuthReady = true;
                // Fallback view if Firebase fails to load
                setView('profile');
            }
        });

    </script>
</body>
</html>
